<div class="order-management-container">
  <h1>Order Management</h1>

  <section class="filters-card">
    <div class="filter-row">
      <label class="filter-label" for="order-search">Search</label>
      <input
        id="order-search"
        type="text"
        [(ngModel)]="filters.search"
        name="search"
        placeholder="Order code, customer, email, phone"
      />
    </div>

    <div class="filter-row">
      <label class="filter-label" for="order-status">Order Status</label>
      <select id="order-status" [(ngModel)]="filters.orderStatus" name="orderStatus">
        <option value="">All</option>
        <option *ngFor="let status of orderStatusOptions" [value]="status">{{ status }}</option>
      </select>

      <label class="filter-label" for="item-status">Item Status</label>
      <select id="item-status" [(ngModel)]="filters.itemStatus" name="itemStatus">
        <option value="">All</option>
        <option *ngFor="let status of itemStatusOptions" [value]="status">{{ status }}</option>
      </select>
    </div>

    <div class="filter-row">
      <label class="filter-label" for="date-from">Created From</label>
      <input id="date-from" type="date" [(ngModel)]="filters.dateFrom" name="dateFrom" />

      <label class="filter-label" for="date-to">To</label>
      <input id="date-to" type="date" [(ngModel)]="filters.dateTo" name="dateTo" />
    </div>

    <div class="filter-actions">
      <button type="button" class="btn primary" (click)="applyFilters()">Apply Filters</button>
      <button type="button" class="btn" (click)="resetFilters()">Reset</button>
    </div>
  </section>

  <div class="status-bar">
    <span *ngIf="meta">Total: {{ meta.total }} | Page {{ meta.page }} of {{ meta.totalPages }}</span>
    <span *ngIf="isLoading" class="loading">Loading…</span>
  </div>

  <div *ngIf="errorMessage" class="alert alert-error">{{ errorMessage }}</div>

  <div *ngIf="!isLoading && !orders.length" class="empty-state">
    No orders match the current filters.
  </div>

  <table class="orders-table" *ngIf="orders.length">
    <thead>
      <tr>
        <th>Order Code</th>
        <th>Customer</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Status</th>
        <th>Total (AUD)</th>
        <th>Created</th>
        <th class="actions-header">Actions</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let order of orders; trackBy: trackByOrderId">
        <tr>
          <td>{{ order.public_order_code }}</td>
          <td>{{ order.customer_name }}</td>
          <td>{{ order.customer_email }}</td>
          <td>{{ order.customer_phone }}</td>
          <td><span class="status-tag">{{ order.order_status }}</span></td>
          <td>{{ order.price_total !== null ? (order.price_total | number:'1.2-2') : '—' }}</td>
          <td>{{ order.created_at | date: 'medium' }}</td>
          <td class="actions-cell">
            <button type="button" class="btn link" (click)="toggleOrderItems(order.order_id)">
              {{ isOrderExpanded(order.order_id) ? 'Hide items' : 'Show items' }}
            </button>
            <button type="button" class="btn link" (click)="openOrderEdit(order)">Edit order</button>
          </td>
        </tr>

        <tr *ngIf="editingOrderId === order.order_id" class="order-edit-row">
          <td colspan="8">
            <form (ngSubmit)="saveOrderEdit(order)" class="edit-form" novalidate>
              <div class="form-grid">
                <label>
                  Customer Name
                  <input type="text" [(ngModel)]="orderEditForm!.customer_name" name="editCustomerName" required />
                </label>
                <label>
                  Customer Email
                  <input type="email" [(ngModel)]="orderEditForm!.customer_email" name="editCustomerEmail" required />
                </label>
                <label>
                  Customer Phone
                  <input type="text" [(ngModel)]="orderEditForm!.customer_phone" name="editCustomerPhone" required />
                </label>
                <label>
                  Order Status
                  <select [(ngModel)]="orderEditForm!.order_status" name="editOrderStatus" required>
                    <option value="" disabled>Select status</option>
                    <option *ngFor="let status of orderStatusOptions" [value]="status">{{ status }}</option>
                  </select>
                </label>
                <label>
                  Price Total (AUD)
                  <input type="text" [(ngModel)]="orderEditForm!.price_total" name="editPriceTotal" placeholder="e.g. 120.00" />
                </label>
                <label class="note-field">
                  Note
                  <textarea [(ngModel)]="orderEditForm!.note" name="editOrderNote" rows="2"></textarea>
                </label>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn primary" [disabled]="isSavingOrder">Save</button>
                <button type="button" class="btn" (click)="cancelOrderEdit()" [disabled]="isSavingOrder">Cancel</button>
              </div>

              <div *ngIf="orderEditError" class="alert alert-error">{{ orderEditError }}</div>
            </form>
          </td>
        </tr>

        <tr *ngIf="isOrderExpanded(order.order_id)" class="order-items-row">
          <td colspan="8">
            <table class="items-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Plate</th>
                  <th>Vehicle</th>
                  <th>Pickup</th>
                  <th>Delivery</th>
                  <th>Status</th>
                  <th>Value</th>
                  <th>Note</th>
                  <th class="actions-header">Actions</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let item of order.items; trackBy: trackByItemId">
                  <tr>
                    <td>{{ item.item_id }}</td>
                    <td>{{ item.snap_plate_number || '—' }}</td>
                    <td>
                      <div>{{ item.snap_maker || '—' }} {{ item.snap_model || '' }}</div>
                      <small *ngIf="item.snap_vin">VIN: {{ item.snap_vin }}</small>
                    </td>
                    <td>{{ item.pickup_location }}</td>
                    <td>{{ item.delivery_location }}</td>
                    <td><span class="status-tag secondary">{{ item.transfer_status }}</span></td>
                    <td>{{ item.snap_vehicle_value !== null ? (item.snap_vehicle_value | number:'1.2-2') : '—' }}</td>
                    <td>{{ item.transfer_note || '—' }}</td>
                    <td class="actions-cell">
                      <button type="button" class="btn link" (click)="openItemEdit(order, item)">Edit item</button>
                    </td>
                  </tr>

                  <tr *ngIf="editingItemId === item.item_id" class="item-edit-row">
                    <td colspan="9">
                      <form (ngSubmit)="saveItemEdit(order, item)" class="edit-form" novalidate>
                        <div class="form-grid">
                          <label>
                            Pickup Location
                            <input type="text" [(ngModel)]="itemEditForm!.pickup_location" name="editPickup" required />
                          </label>
                          <label>
                            Delivery Location
                            <input type="text" [(ngModel)]="itemEditForm!.delivery_location" name="editDelivery" required />
                          </label>
                          <label>
                            Transfer Status
                            <select [(ngModel)]="itemEditForm!.transfer_status" name="editTransferStatus" required>
                              <option value="" disabled>Select status</option>
                              <option *ngFor="let status of itemStatusOptions" [value]="status">{{ status }}</option>
                            </select>
                          </label>
                          <label>
                            Vehicle Value (AUD)
                            <input type="text" [(ngModel)]="itemEditForm!.snap_vehicle_value" name="editVehicleValue" placeholder="e.g. 45000.00" />
                          </label>
                          <label>
                            Plate Number
                            <input type="text" [(ngModel)]="itemEditForm!.snap_plate_number" name="editPlate" />
                          </label>
                          <label>
                            VIN
                            <input type="text" [(ngModel)]="itemEditForm!.snap_vin" name="editVin" />
                          </label>
                          <label>
                            Maker
                            <input type="text" [(ngModel)]="itemEditForm!.snap_maker" name="editMaker" />
                          </label>
                          <label>
                            Model
                            <input type="text" [(ngModel)]="itemEditForm!.snap_model" name="editModel" />
                          </label>
                          <label>
                            Colour
                            <input type="text" [(ngModel)]="itemEditForm!.snap_colour" name="editColour" />
                          </label>
                          <label class="note-field">
                            Transfer Note
                            <textarea [(ngModel)]="itemEditForm!.transfer_note" name="editTransferNote" rows="2"></textarea>
                          </label>
                        </div>

                        <div class="form-actions">
                          <button type="submit" class="btn primary" [disabled]="isSavingItem">Save</button>
                          <button type="button" class="btn" (click)="cancelItemEdit()" [disabled]="isSavingItem">Cancel</button>
                        </div>

                        <div *ngIf="itemEditError" class="alert alert-error">{{ itemEditError }}</div>
                      </form>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <div class="pagination-bar" *ngIf="meta && meta.totalPages > 1">
    <button type="button" class="btn" (click)="prevPage()" [disabled]="currentPage <= 1">Previous</button>
    <span>Page {{ currentPage }} of {{ meta.totalPages }}</span>
    <button type="button" class="btn" (click)="nextPage()" [disabled]="!meta.hasMore">Next</button>
  </div>
</div>
